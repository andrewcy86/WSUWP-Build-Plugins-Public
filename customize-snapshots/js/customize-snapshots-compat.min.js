!function(a,b){"use strict";var c=27;a.Snapshots=a.Class.extend({data:{action:"",uuid:"",editLink:"",title:"",publishDate:"",postStatus:"",currentUserCanPublish:!0,initialServerDate:"",initialServerTimestamp:0,initialClientTimestamp:0,previewingTheme:"",i18n:{},dirty:!1},uuidParam:"customize_changeset_uuid",initialize:function(c){var d=this;d.schedule={},_.isObject(c)&&_.extend(d.data,c),d.data.initialClientTimestamp=d.dateValueOf(),a.bind("ready",function(){a.state.create("snapshot-exists",!1),a.state.create("snapshot-saved",!0),a.state.create("snapshot-submitted",!0),d.data.uuid=d.data.uuid||a.settings.changeset.uuid,d.data.title=d.data.title||d.data.uuid,d.editBoxAutoSaveTriggered=!1,a.state.has("changesetStatus")&&a.state("changesetStatus").get()&&a.state("snapshot-exists").set(!0),d.extendPreviewerQuery(),d.editControlSettings=new a.Values,d.editControlSettings.create("title",d.data.title),d.editControlSettings.create("date",d.data.publishDate),a.bind("change",function(){a.state("snapshot-submitted").set(!1)}),d.frontendPreviewUrl=new a.Value(a.previewer.previewUrl.get()),d.frontendPreviewUrl.link(a.previewer.previewUrl),d.isNotSavedPreviewingTheme=!1,d.addButtons(),d.editSnapshotUI(),d.prefilterAjax(),a.trigger("snapshots-ready",d)}),a.bind("save",function(c){return c.fail(function(c){var e="#snapshot-dialog-error",f=wp.template("snapshot-dialog-error");c.responseText&&(0===b(e).length&&b("body").append(f({title:d.data.i18n.publish,message:a.state("snapshot-exists").get()?d.data.i18n.permsMsg.update:d.data.i18n.permsMsg.save})),d.spinner.removeClass("is-active"),b(e).dialog({autoOpen:!0,modal:!0}))}),c})},getStateQueryVars:function(){var b,c=this;return b={"autofocus[control]":null,"autofocus[section]":null,"autofocus[panel]":null},b.scroll=parseInt(a.previewer.scroll,10)||0,b.device=a.previewedDevice.get(),b.url=a.previewer.previewUrl.get(),a.state("activated").get()&&!c.isNotSavedPreviewingTheme||(b.previewing_theme=!0),_.find(["control","section","panel"],function(c){var d=!1;return a[c].each(function(a){!d&&a.expanded&&a.expanded.get()&&(b["autofocus["+c+"]"]=a.id,d=!0)}),d}),b},updateSnapshot:function(a){var c,d,e=this,f=new b.Deferred,g={status:a};return e.statusButton&&e.statusButton.needConfirm?(e.statusButton.disbleButton.set(!1),e.statusButton.updateButtonText("confirm-text"),e.statusButton.needConfirm=!1,f.promise()):(e.snapshotTitle&&e.snapshotTitle.val()&&"publish"!==a&&(g.title=e.editControlSettings("title").get()),!_.isEmpty(e.editContainer)&&e.isFutureDate()&&"publish"!==a&&(c=e.getDateFromInputs(),g.date=e.formatDate(c)),"future"===a?g.date&&(d=e.sendUpdateSnapshotRequest(g)):d=e.sendUpdateSnapshotRequest(g),d?d:f.promise())},sendUpdateSnapshotRequest:function(c){var d,e,f,g=this;return e=_.extend({status:"draft"},c),a.state("snapshot-saved").set(!1),g.statusButton.disable(!0),g.spinner.addClass("is-active"),d=a.previewer.save(e),f="publish"===e.status,d.always(function(a){g.spinner.removeClass("is-active"),a.edit_link&&(g.data.editLink=a.edit_link),a.publish_date&&(g.data.publishDate=a.publish_date),a.title&&(g.data.title=a.title),g.data.dirty=!1}),d.done(function(b){var c=a.previewer.previewUrl(),d=window.location.href,h=400;_.delay(function(){a.state("snapshot-saved").set(!0),"pending"===e.status&&a.state("snapshot-submitted").set(!0)},h),a.state("snapshot-exists").set(!f),g.statusButton.disableSelect.set(f),g.statusButton.disbleButton.set(!0),g.snapshotExpandButton.toggle(!f),g.previewLink.toggle(!f),f&&g.removeParamFromClose("customize_changeset_uuid"),g.statusButton.updateButtonText("alt-text"),a.trigger("customize-snapshots-update",{previewUrl:c,customizeUrl:d,uuid:g.data.uuid,response:b})}),d.fail(function(a){var c,d="#snapshot-dialog-error",e=wp.template("snapshot-dialog-error"),f=g.data.i18n.errorMsg,h=0;g.statusButton.disableSelect.set(!1),g.statusButton.disbleButton.set(!1),a.setting_validities&&(h=_.size(a.setting_validities,function(a){return!0!==a})),h>0||(a.errors&&(f+=" "+_.pluck(a.errors,"message").join(" ")),c=b(d),c.length||(c=b(e({title:g.data.i18n.errorTitle,message:f})),b("body").append(c)),b(d).dialog({autoOpen:!0,modal:!0}))}),d},addButtons:function(){var c,d,e,f,g=this,h=!0,i=!0;g.spinner=b("#customize-header-actions").find(".spinner"),g.publishButton=b("#save"),g.publishButton.addClass("hidden"),g.statusButton=g.addStatusButton(),a.state("changesetStatus").get()&&(i=!1,"auto-draft"===a.state("changesetStatus").get()?h=!1:g.statusButton.updateButtonText("alt-text")),d=a.settings.theme.stylesheet,e=g.data.previewingTheme,f=!a.state("activated").get()&&!e,g.isNotSavedPreviewingTheme=e&&e!==d,(f||g.isNotSavedPreviewingTheme)&&(h=!1,i=!1),g.statusButton.disbleButton.set(h),g.statusButton.disableSelect.set(i),g.previewLink=b(b.trim(wp.template("snapshot-preview-link")())),g.previewLink.toggle(a.state("snapshot-saved").get()),g.previewLink.attr("target",g.data.uuid),c=_.debounce(function(){var c;a.state("snapshot-exists").get()?g.previewLink.attr("href",g.getSnapshotFrontendPreviewUrl()):g.previewLink.attr("href",g.frontendPreviewUrl.get()),a.state("activated").get()||(c=g.parseQueryString(g.previewLink.prop("search").substr(1)),c.customize_theme=a.settings.theme.stylesheet,g.previewLink.prop("search",b.param(c)))}),g.frontendPreviewUrl.bind(c),c(),a.state.bind("change",c),a.bind("saved",c),g.statusButton.container.after(g.previewLink),a.state("snapshot-saved").bind(function(a){g.previewLink.toggle(a)}),g.snapshotExpandButton=b(b.trim(wp.template("snapshot-expand-button")({}))),g.statusButton.container.after(g.snapshotExpandButton),g.data.editLink||(g.snapshotExpandButton.hide(),g.previewLink.hide()),a.state("change",function(){g.snapshotExpandButton.toggle(a.state("snapshot-saved").get()&&a.state("snapshot-exists").get())}),a.state("snapshot-exists").bind(function(a){g.snapshotExpandButton.toggle(a),g.previewLink.toggle(a)}),a.bind("change",function(){a.state("snapshot-saved").get()&&(g.statusButton.disable(!1),g.statusButton.button.data("confirm-text")!==g.statusButton.buttonText.get()&&g.statusButton.updateButtonText("button-text"),g.submitButton&&g.submitButton.prop("disabled",!1),g.saveButton&&g.saveButton.prop("disabled",!1),a.state("snapshot-saved").set(!1))}),g.data.currentUserCanPublish||(g.addSubmitButton(),g.addSaveButton())},addSubmitButton:function(){var c,d=this;c="pending"===d.data.postStatus||!a.state("snapshot-exists").get(),d.statusButton?d.statusButton.container.hide():d.publishButton.hide(),d.submitButton=b(b.trim(wp.template("snapshot-submit")({buttonText:d.data.i18n.submit}))),d.submitButton.prop("disabled",c),d.submitButton.insertBefore(d.publishButton),a.state("snapshot-submitted").bind(function(a){d.submitButton.prop("disabled",a)}),d.submitButton.on("click",function(a){a.preventDefault(),d.submitButton.prop("disabled",!0),d.saveButton&&d.saveButton.prop("disabled",!0),d.updateSnapshot("pending").fail(function(){d.submitButton.prop("disabled",!1)})}),d.editControlSettings.bind("change",function(){a.state("snapshot-saved").get()&&d.submitButton.prop("disabled",!1)})},addSaveButton:function(){var c,d,e=this;d=_.contains(["future","pending","draft"],a.state("changesetStatus").get()),c=d||!a.state("snapshot-exists").get(),e.saveButton=b(b.trim(wp.template("snapshot-save")({buttonText:d?e.data.i18n.updateButton:e.data.i18n.saveButton}))),e.saveButton.prop("disabled",c),e.saveButton.insertBefore(e.publishButton),a.state("snapshot-submitted").bind(function(a){a&&e.saveButton.prop("disabled",!0)}),e.saveButton.on("click",function(a){a.preventDefault(),e.saveButton.prop("disabled",!0),e.submitButton.prop("disabled",!0),e.updateSnapshot("draft").done(function(){e.saveButton.prop("disabled",!0),e.submitButton.prop("disabled",!1),e.saveButton.text(e.data.i18n.updateButton)}).fail(function(){e.saveButton.prop("disabled",!1),e.submitButton.prop("disabled",!1)})}),e.editControlSettings.bind("change",function(){a.state("snapshot-saved").get()&&e.saveButton.prop("disabled",!1)})},editSnapshotUI:function(){var d,e,f=this,g=0,h=-2;f.snapshotEditContainerDisplayed=new a.Value((!1)),d=function(){f.populateSetting()},_.isEmpty(f.editContainer)&&("0000-00-00 00:00:00"===f.data.publishDate&&(f.data.publishDate=f.getCurrentTime()),f.data.publishDate=f.data.publishDate.slice(g,h)+"00",f.data=_.extend(f.data,f.parseDateTime(f.data.publishDate)),f.editContainer=b(b.trim(wp.template("snapshot-edit-container")(f.data))),f.editContainer.hide().appendTo(b("#customize-header-actions")),f.dateNotification=f.editContainer.find(".snapshot-future-date-notification"),f.countdown=f.editContainer.find(".snapshot-scheduled-countdown"),f.dateControl=f.editContainer.find(".snapshot-control-date"),f.data.currentUserCanPublish&&(f.schedule.inputs=f.editContainer.find(".date-input"),f.schedule.inputs.on("input",d),f.schedule.inputs.on("blur",function(){f.populateInputs(),d()}),f.updateCountdown(),f.editContainer.find(".reset-time a").on("click",function(a){a.preventDefault(),f.updateSnapshotEditControls()})),f.statusButton&&"future"!==f.statusButton.value.get()&&f.countdown.hide(),f.snapshotTitle=f.editContainer.find("#snapshot-title"),f.snapshotTitle.on("input",d)),e=function(){_.isEmpty(f.dateNotification)||f.dateNotification.toggle(!f.isFutureDate())},f.snapshotEditContainerDisplayed.bind(function(a){f.statusButton&&f.dateControl.toggle("future"===f.statusButton.value.get()),a?(f.editContainer.stop().slideDown("fast").attr("aria-expanded","true"),f.snapshotExpandButton.attr("aria-pressed","true"),f.snapshotExpandButton.prop("title",f.data.i18n.collapseSnapshotScheduling),e()):(f.editContainer.stop().slideUp("fast").attr("aria-expanded","false"),f.snapshotExpandButton.attr("aria-pressed","false"),f.snapshotExpandButton.prop("title",f.data.i18n.expandSnapshotScheduling))}),f.editControlSettings("date").bind(function(){e()}),f.snapshotExpandButton.on("click",function(){f.snapshotEditContainerDisplayed.set(!f.snapshotEditContainerDisplayed.get())}),f.snapshotExpandButton.on("keydown",function(a){c===a.which&&f.snapshotEditContainerDisplayed.get()&&(a.stopPropagation(),a.preventDefault(),f.snapshotEditContainerDisplayed.set(!1))}),f.editContainer.on("keydown",function(a){c===a.which&&f.snapshotEditContainerDisplayed.get()&&(a.stopPropagation(),a.preventDefault(),f.snapshotEditContainerDisplayed.set(!1),f.snapshotExpandButton.focus())}),b("body").on("mousedown",function(a){var b=f.snapshotEditContainerDisplayed.get(),c=f.editContainer.is(a.target)||0!==f.editContainer.has(a.target).length,d=f.snapshotExpandButton.is(a.target);!b||c||d||f.snapshotEditContainerDisplayed.set(!1)}),f.snapshotEditContainerDisplayed.set(!1),a.state("snapshot-saved").bind(function(a){a&&!f.dirtyEditControlValues&&f.updateSnapshotEditControls()}),a.bind("change",function(){f.data.dirty=!0,f.editContainer.find("a.snapshot-edit-link").hide()}),a.state("snapshot-exists").bind(function(a){a&&!_.isEmpty(f.editContainer)?f.updateSnapshotEditControls():f.snapshotEditContainerDisplayed.set(!1)}),f.statusButton&&f.updateSnapshotEditControls(),f.autoSaveEditBox()},autoSaveEditBox:function(){var c,d,e,f=this,g=2e3;f.updatePending=!1,f.dirtyEditControlValues=!1,c=_.debounce(function(){return d=f.statusButton.value.get(),e="future"===d&&!f.isFutureDate(),"publish"===d||e?void(f.updatePending=!1):(f.updatePending=!0,f.editBoxAutoSaveTriggered=!0,f.dirtyEditControlValues=!1,void f.updateSnapshot(d).done(function(){f.updatePending=f.dirtyEditControlValues,f.updatePending?f.dirtyEditControlValues&&c():f.updateSnapshotEditControls(),f.dirtyEditControlValues=!1}).fail(function(){f.updatePending=!1,f.dirtyEditControlValues=!0}))},g),f.editControlSettings("title").bind(function(){f.dirtyEditControlValues=!0,f.updatePending||c()}),f.editControlSettings("date").bind(function(){f.isFutureDate()&&(f.dirtyEditControlValues=!0,f.updatePending||c())}),b(window).on("beforeunload.customize-confirm",function(){if(f.updatePending||f.dirtyEditControlValues)return f.data.i18n.aysMsg}),a.bind("changeset-saved",function(){"auto-draft"!==a.state("changesetStatus").get()&&a.state("saved").set(!0)})},getSnapshotFrontendPreviewUrl:function(){var a=this,b=document.createElement("a");return b.href=a.frontendPreviewUrl.get(),b.search&&(b.search+="&"),b.search+=a.uuidParam+"="+a.data.uuid,b.href},updateSnapshotEditControls:function(){var c,d,e=this,f=0,g=-2;_.isEmpty(e.editContainer)||(d=a.state("changesetStatus").get(),e.data.currentUserCanPublish&&("0000-00-00 00:00:00"!==e.data.publishDate&&d&&"auto-draft"!==d||(e.data.publishDate=e.getCurrentTime()),e.data.publishDate=e.data.publishDate.slice(f,g)+"00",c=e.parseDateTime(e.data.publishDate),e.schedule.inputs.each(function(){var a=b(this),d=a.data("date-input");b(this).val(c[d])})),e.editContainer.find("a.snapshot-edit-link").attr("href",e.data.editLink).show(),_.isEmpty(e.data.title)||e.snapshotTitle.val(e.data.title),e.populateSetting())},updateCountdown:function(){var a,b=this,c=wp.template("snapshot-scheduled-countdown"),d=b.getDateFromInputs(),e=1e3;return!!d&&(a=d.valueOf(),a-=b.dateValueOf(b.getCurrentTime()),a=Math.ceil(a/e),0<a?(b.countdown.text(c({remainingTime:a})),b.countdown.show()):b.countdown.hide(),!0)},getDateFromInputs:function(){var a,b=this,c=b.editContainer,d=1;return a=new Date(parseInt(c.find('[data-date-input="year"]').val(),10),parseInt(c.find('[data-date-input="month"]').val(),10)-d,parseInt(c.find('[data-date-input="day"]').val(),10),parseInt(c.find('[data-date-input="hour"]').val(),10),parseInt(c.find('[data-date-input="minute"]').val(),10)),isNaN(a.valueOf())?null:(a.setSeconds(0),a)},parseDateTime:function(a){var b=a.match(/^(\d\d\d\d)-(\d\d)-(\d\d) (\d\d):(\d\d):(\d\d)$/);return b?(b.shift(),{year:b.shift(),month:b.shift(),day:b.shift(),hour:b.shift(),minute:b.shift(),second:b.shift()}):null},formatDate:function(a){var b,c=4,d=2,e=1;return b=("0000"+String(a.getFullYear())).substr(-c,c),b+="-"+("00"+String(a.getMonth()+e)).substr(-d,d),b+="-"+("00"+String(a.getDate())).substr(-d,d),b+=" "+("00"+String(a.getHours())).substr(-d,d),b+=":"+("00"+String(a.getMinutes())).substr(-d,d),b+=":"+("00"+String(a.getSeconds())).substr(-d,d)},populateInputs:function(){var a,c=this;return!c.schedule.inputs.is(":focus")&&"0000-00-00 00:00:00"!==c.data.publishDate&&(!!(a=c.parseDateTime(c.data.publishDate))&&(c.schedule.inputs.each(function(){var c=b(this),d=c.data("date-input");b(this).is("select")||""!==b(this).val()||b(this).val(a[d])}),!0))},populateSetting:function(){var a,b=this,c=b.getDateFromInputs();b.editControlSettings("title").set(b.snapshotTitle.val()),c&&b.data.currentUserCanPublish&&(c.setSeconds(0),a=b.formatDate(c)!==b.data.publishDate,b.editControlSettings("date").set(b.formatDate(c)),"future"===b.statusButton.value.get()&&b.updateCountdown(),b.editContainer.find(".reset-time").toggle(a))},isFutureDate:function(){var a,b=this,c=b.getDateFromInputs(),d=1e3;return!!c&&(a=b.dateValueOf(c),a-=b.dateValueOf(b.getCurrentTime()),a=Math.ceil(a/d),0<a)},getCurrentTime:function(){var a,b,c,d=this;return b=(new Date).valueOf(),a=d.parsePostDate(d.data.initialServerDate),c=b-d.data.initialClientTimestamp,c+=d.data.initialClientTimestamp-d.data.initialServerTimestamp,a.setTime(a.getTime()+c),d.formatDate(a)},parsePostDate:function(a){var b=_.map(a.split(/\D/),function(a){return parseInt(a,10)});return new Date(b[0],b[1]-1,b[2],b[3],b[4],b[5])},dateValueOf:function(a){var b;return b="string"==typeof a?new Date(a):a instanceof Date?a:new Date,b.valueOf()},extendPreviewerQuery:function(){var b=this,c=a.previewer.query;a.previewer.query=function(){var a=c.apply(this,arguments);return _.contains(["future","pending","draft"],b.statusButton.value.get())?(a.customizer_state_query_vars=JSON.stringify(b.getStateQueryVars()),b.editControlSettings("title").get()&&(a.customize_changeset_title=b.editControlSettings("title").get()),b.editControlSettings("date").get()&&b.isFutureDate()&&(a.customize_changeset_date=b.editControlSettings("date").get()),a):a}},addStatusButton:function(){var c,d,e,f,g,h,i=this;return g=a.state("changesetStatus").get(),d={},h=g&&"auto-draft"!==g?g:"publish",d.value=new a.Value(h),d.disbleButton=new a.Value,d.disableSelect=new a.Value,d.buttonText=new a.Value,d.needConfirm=!1,d.container=b(b.trim(wp.template("snapshot-status-button")({selected:h}))),d.button=d.container.find(".snapshot-status-button-overlay"),d.select=d.container.find("select"),d.select.selectmenu({width:"auto",icons:{button:"dashicons dashicons-arrow-down"},change:function(a,b){d.value.set(b.item.value)},select:function(){d.hiddenButton&&d.hiddenButton.text(d.buttonText.get())}}),c=d.container.find(".ui-selectmenu-button"),d.hiddenButton=c.find(".ui-selectmenu-text"),d.hiddenButton.addClass("button button-primary"),d.dropDown=c.find(".ui-icon"),d.dropDown.addClass("button button-primary"),d.updateButtonText=function(a){f=d.button.data(a),d.button.text(f),d.hiddenButton.text(f),d.buttonText.set(f)},d.value.bind(function(a){e=d.select.find("option:selected"),d.button.data("alt-text",e.data("alt-text")),d.button.data("button-text",e.text()),d.updateButtonText("button-text"),"publish"===a&&(i.snapshotExpandButton.hide(),d.button.data("confirm-text",e.data("confirm-text")),d.button.data("publish-text",e.data("publish-text")),d.needConfirm=!0),"future"===a?(i.snapshotEditContainerDisplayed.set(!0),i.snapshotExpandButton.show(),i.isFutureDate()&&(i.countdown.show(),i.updateSnapshot(a))):(i.updateSnapshot(a),i.snapshotEditContainerDisplayed.set(!1),i.countdown.hide())}),d.disbleButton.bind(function(a){d.button.prop("disabled",a)}),d.disableSelect.bind(function(a){d.select.selectmenu(a?"disable":"enable"),d.dropDown.toggleClass("disabled",a)}),d.disable=function(a){d.disableSelect.set(a),d.disbleButton.set(a)},d.button.on("click",function(a){a.preventDefault(),i.updateSnapshot(d.value.get())}),i.publishButton.after(d.container),d},prefilterAjax:function(){var c,d,e=this;a.state.has("changesetStatus")&&(c=function(a,b){var c=a.split(/[&;]/g);return _.each(c,function(a,d){a&&a.lastIndexOf(b,0)!==-1&&c.splice(d,1)}),c.join("&")},b.ajaxPrefilter(function(b,f){f.data&&e.editBoxAutoSaveTriggered&&(d=a.state("changesetStatus").get()===f.data.customize_changeset_status,"customize_save"===f.data.action&&b.data&&f.data.customize_changeset_status&&d&&(b.data=c(b.data,"customize_changeset_status"),e.editBoxAutoSaveTriggered=!1))}))},removeParamFromClose:function(a){var c,d,e,f=this;c=b(".customize-controls-close"),d=c.prop("search").substr(1),d.length&&(e=f.parseQueryString(d),delete e[a],c.prop("search",b.param(e)))},parseQueryString:a.utils.parseQueryString})}(wp.customize,jQuery);