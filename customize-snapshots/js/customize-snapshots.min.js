!function(a,b){"use strict";a.Snapshots=a.Class.extend({data:{inspectLink:"",title:"",i18n:{title:"",savePending:"",pendingSaved:"",aysMsg:""}},initialize:function(c){var d=this;_.isObject(c)&&_.extend(d.data,c),a.bind("ready",function(){var c=b("#save");d.data.title=d.data.title||a.settings.changeset.uuid,a.state.create("changesetTitle",d.data.title),a.state.create("changesetInspectUrl",d.data.inspectLink),a.control("changeset_scheduled_date",d.setupScheduledChangesetCountdown),a.bind("save-request-params",function(b){b.customizer_state_query_vars=JSON.stringify(d.getStateQueryVars()),b.customize_changeset_title=a.state("changesetTitle")}),a.state.bind("change",function(){a.state("activated").get()&&"pending"===a.state("selectedChangesetStatus").get()&&(a.state("saved").get()&&a.state("selectedChangesetStatus").get()===a.state("changesetStatus").get()?c.val(d.data.i18n.pendingSaved):c.val(d.data.i18n.savePending))}),a.section("publish_settings",function(a){d.addPendingToStatusControl(),d.addTitleControl(a),d.addInspectChangesetControl(a)}),d.frontendPreviewUrl=new a.Value(a.previewer.previewUrl.get()),d.frontendPreviewUrl.link(a.previewer.previewUrl),a.trigger("snapshots-ready",d)}),a.bind("save",function(b){b.done(function(b){b.edit_link&&a.state("changesetInspectUrl").set(b.edit_link),b.title&&a.state("changesetTitle").set(b.title),a.trigger("customize-snapshots-update",b)})})},addTitleControl:function(c){var d,e=this;d=new a.Control("changeset_title",{type:"text",label:e.data.i18n.title,section:c.id,setting:a.state("changesetTitle"),priority:31}),a.control.add(d),a.state("changesetTitle").bind(function(){a.state("saved").set(!1)}),b(window).on("beforeunload.customize-confirm",function(){if(!a.state("saved").get())return e.data.i18n.aysMsg})},getStateQueryVars:function(){var b,c=this;return b={"autofocus[control]":null,"autofocus[section]":null,"autofocus[panel]":null},b.scroll=parseInt(a.previewer.scroll,10)||0,b.device=a.previewedDevice.get(),b.url=a.previewer.previewUrl.get(),a.state("activated").get()&&!c.isNotSavedPreviewingTheme||(b.previewing_theme=!0),_.find(["control","section","panel"],function(c){var d=!1;return a[c].each(function(a){!d&&a.expanded&&a.expanded.get()&&(b["autofocus["+c+"]"]=a.id,d=!0)}),d}),b},setupScheduledChangesetCountdown:function(c){var d,e,f;d=wp.template("snapshot-scheduled-countdown"),e=b("<div>",{"class":"snapshot-countdown-container hidden"}),f=function(b){a.state("changesetTitle").set(b.next_changeset_uuid),a.state("saved").set(!0),a.unbind("saved",f)},c.deferred.embedded.done(function(){c.container.append(e),a.state("remainingTimeToPublish").bind(function(b){0===parseInt(b,10)&&a.bind("saved",f),e.removeClass("hidden").html(d({remainingTime:b}))}),a.state("changesetStatus").bind(function(a){"future"!==a&&e.addClass("hidden")})})},addInspectChangesetControl:function(b){var c;c=a.Control.extend({defaults:_.extend({},a.Control.prototype.defaults,{templateId:"snapshot-inspect-link-control"}),ready:function(){var b,c=this;b=c.container.find("a"),b.attr("href",c.setting()),c.setting.bind(function(a){b.attr("href",a)}),c.toggleInspectChangesetControl(),a.state("changesetStatus").bind(function(){c.toggleInspectChangesetControl()})},toggleInspectChangesetControl:function(){this.active.set(!_.contains(["","auto-draft"],a.state("changesetStatus").get()))}}),a.control.add(new c("inspect_changeset",{type:"inspect-changeset-link",section:b.id,priority:30,setting:a.state("changesetInspectUrl")}))},addPendingToStatusControl:function(){var b,c,d=this,e=0;c=a.control("changeset_status"),c.deferred.embedded.done(function(){b=_.extend({},c.params),c.container.remove(),a.control.remove("changeset_status"),_.each(b.choices,function(a,b){"draft"===a.status&&(e=b)}),b.choices.splice(e+1,0,{label:d.data.i18n.savePending,status:"pending"}),a.control.add(new a.Control("changeset_status",b))})},getSnapshotFrontendPreviewUrl:function(){return a.previewer.getFrontendPreviewUrl()}})}(wp.customize,jQuery);